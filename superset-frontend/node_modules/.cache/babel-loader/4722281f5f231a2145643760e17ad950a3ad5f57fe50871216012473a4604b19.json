{"ast":null,"code":"(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport { useState, useRef, useCallback } from 'react';\nimport { useHistory, withRouter } from 'react-router-dom';\nimport moment from 'moment';\nimport { Behavior, css, isFeatureEnabled, FeatureFlag, getChartMetadataRegistry, styled, t, useTheme, ensureIsArray } from '@superset-ui/core';\nimport { useSelector } from 'react-redux';\nimport { MenuItemKeyEnum, Menu, isAntdMenuItem, isAntdMenuItemRef, isSubMenuOrItemType, isAntdMenuSubmenu } from 'src/components/Menu';\nimport { NoAnimationDropdown } from 'src/components/Dropdown';\nimport ShareMenuItems from 'src/dashboard/components/menu/ShareMenuItems';\nimport downloadAsImage from 'src/utils/downloadAsImage';\nimport { getSliceHeaderTooltip } from 'src/dashboard/util/getSliceHeaderTooltip';\nimport { Tooltip } from 'src/components/Tooltip';\nimport Icons from 'src/components/Icons';\nimport ModalTrigger from 'src/components/ModalTrigger';\nimport Button from 'src/components/Button';\nimport ViewQueryModal from 'src/explore/components/controls/ViewQueryModal';\nimport { ResultsPaneOnDashboard } from 'src/explore/components/DataTablesPane';\nimport Modal from 'src/components/Modal';\nimport { DrillDetailMenuItems } from 'src/components/Chart/DrillDetail';\nimport { LOG_ACTIONS_CHART_DOWNLOAD_AS_IMAGE } from 'src/logger/LogUtils';\nimport { MenuKeys } from 'src/dashboard/types';\nimport { findPermission } from 'src/utils/findPermission';\nimport { useCrossFiltersScopingModal } from '../nativeFilters/FilterBar/CrossFilters/ScopingModal/useCrossFiltersScopingModal';import { jsx as _jsx, jsxs as _jsxs, Fragment as _Fragment } from \"@emotion/react/jsx-runtime\";\nconst ACTION_KEYS = {\n  enter: 'Enter',\n  spacebar: 'Spacebar',\n  space: ' '\n};\nconst NAV_KEYS = {\n  tab: 'Tab',\n  escape: 'Escape',\n  up: 'ArrowUp',\n  down: 'ArrowDown'\n};\n// TODO: replace 3 dots with an icon\nconst VerticalDotsContainer = styled.div`\n  padding: ${({ theme }) => theme.gridUnit / 4}px\n    ${({ theme }) => theme.gridUnit * 1.5}px;\n\n  .dot {\n    display: block;\n\n    height: ${({ theme }) => theme.gridUnit}px;\n    width: ${({ theme }) => theme.gridUnit}px;\n    border-radius: 50%;\n    margin: ${({ theme }) => theme.gridUnit / 2}px 0;\n\n    background-color: ${({ theme }) => theme.colors.text.label};\n  }\n\n  &:hover {\n    cursor: pointer;\n  }\n`;\nconst RefreshTooltip = styled.div`\n  height: auto;\n  margin: ${({ theme }) => theme.gridUnit}px 0;\n  color: ${({ theme }) => theme.colors.grayscale.base};\n  line-height: 21px;\n  display: flex;\n  flex-direction: column;\n  align-items: flex-start;\n  justify-content: flex-start;\n`;\nconst getScreenshotNodeSelector = (chartId) => `.dashboard-chart-id-${chartId}`;\nconst VerticalDotsTrigger = () => _jsxs(VerticalDotsContainer, { children: [\n  _jsx(\"span\", { className: \"dot\" }),\n  _jsx(\"span\", { className: \"dot\" }),\n  _jsx(\"span\", { className: \"dot\" })] }\n);\nconst dropdownIconsStyles = css`\n  &&.anticon > .anticon:first-child {\n    margin-right: 0;\n    vertical-align: 0;\n  }\n`;\n/**\n * A MenuItem can be recognized in the tree by the presence of a ref\n *\n * @param children\n * @param currentKeys\n * @returns an array of keys\n */\nconst extractMenuItemRefs = (child) => {\n  // check that child has props\n  const childProps = child == null ? void 0 : child.props;\n  // loop through each prop\n  if (childProps) {\n    const arrayProps = Object.values(childProps);\n    // check if any is of type ref MenuItem\n    const refs = arrayProps.filter((ref) => isAntdMenuItemRef(ref));\n    return refs;\n  }\n  return [];\n};\n/**\n * Recursively extracts keys from menu items\n *\n * @param children\n * @param currentKeys\n * @returns an array of keys and their refs\n *\n */\nconst extractMenuItemsKeys = (children, currentKeys) => {\n  const allKeys = currentKeys || [];\n  const arrayChildren = ensureIsArray(children);\n  arrayChildren.forEach((child) => {var _child$props;\n    const isMenuItem = isAntdMenuItem(child);\n    const refs = extractMenuItemRefs(child);\n    // key is immediately available in a standard MenuItem\n    if (isMenuItem) {\n      const { key } = child;\n      if (key) {\n        allKeys.push({\n          key\n        });\n      }\n    }\n    // one or more menu items refs are available\n    if (refs.length) {\n      allKeys.push(...refs.map((ref) => ({ key: ref.current.props.eventKey, ref })));\n    }\n    // continue to extract keys from nested children\n    if (child != null && (_child$props = child.props) != null && _child$props.children) {\n      const childKeys = extractMenuItemsKeys(child.props.children, allKeys);\n      allKeys.push(...childKeys);\n    }\n  });\n  return allKeys;\n};\n/**\n * Generates a map of keys and their types for a MenuItem\n * Individual refs can be given to extract keys from nested items\n * Refs can be used to control the event handlers of the menu items\n *\n * @param itemChildren\n * @param type\n * @returns a map of keys and their types\n */\nconst extractMenuItemsKeyMap = (children) => {\n  const keysMap = {};\n  const childrenArray = ensureIsArray(children);\n  childrenArray.forEach((child) => {var _child$props2;\n    const isMenuItem = isAntdMenuItem(child);\n    const isSubmenu = isAntdMenuSubmenu(child);\n    const menuItemsRefs = extractMenuItemRefs(child);\n    // key is immediately available in MenuItem or SubMenu\n    if (isMenuItem || isSubmenu) {\n      const directKey = child == null ? void 0 : child.key;\n      if (directKey) {\n        keysMap[directKey] = {};\n        keysMap[directKey].type = isSubmenu ?\n        MenuItemKeyEnum.SubMenu :\n        MenuItemKeyEnum.MenuItem;\n      }\n    }\n    // one or more menu items refs are available\n    if (menuItemsRefs.length) {\n      menuItemsRefs.forEach((ref) => {\n        const key = ref.current.props.eventKey;\n        keysMap[key] = {};\n        keysMap[key].type = isSubmenu ?\n        MenuItemKeyEnum.SubMenu :\n        MenuItemKeyEnum.MenuItem;\n        keysMap[key].parent = child.key;\n        keysMap[key].ref = ref;\n      });\n    }\n    // if it has children must check for the presence of menu items\n    if (child != null && (_child$props2 = child.props) != null && _child$props2.children) {var _child$props3;\n      const theChildren = child == null ? void 0 : (_child$props3 = child.props) == null ? void 0 : _child$props3.children;\n      const childKeys = extractMenuItemsKeys(theChildren);\n      childKeys.forEach((keyMap) => {\n        const k = keyMap.key;\n        keysMap[k] = {};\n        keysMap[k].type = MenuItemKeyEnum.SubMenuItem;\n        keysMap[k].parent = child.key;\n        if (keyMap.ref) {\n          keysMap[k].ref = keyMap.ref;\n        }\n      });\n    }\n  });\n  return keysMap;\n};\n/**\n *\n * Determines the next key to select based on the current key and direction\n *\n * @param keys\n * @param keysMap\n * @param currentKeyIndex\n * @param direction\n * @returns the selected key and the open key\n */\nconst getNavigationKeys = (keys, keysMap, currentKeyIndex, direction = 'up') => {var _keysMap$selectedKey;\n  const step = direction === 'up' ? -1 : 1;\n  const skipStep = direction === 'up' ? -2 : 2;\n  const keysLen = direction === 'up' ? 0 : keys.length;\n  const mathFn = direction === 'up' ? Math.max : Math.min;\n  let openKey;\n  let selectedKey = keys[mathFn(currentKeyIndex + step, keysLen)];\n  // go to first key if current key is the last\n  if (!selectedKey) {\n    return { selectedKey: keys[0], openKey: undefined };\n  }\n  const isSubMenu = ((_keysMap$selectedKey = keysMap[selectedKey]) == null ? void 0 : _keysMap$selectedKey.type) === MenuItemKeyEnum.SubMenu;\n  if (isSubMenu) {\n    // this is a submenu, skip to first submenu item\n    selectedKey = keys[mathFn(currentKeyIndex + skipStep, keysLen)];\n  }\n  // re-evaulate if current selected key is a submenu or submenu item\n  if (!isSubMenuOrItemType(keysMap[selectedKey].type)) {\n    openKey = undefined;\n  } else\n  {\n    const parentKey = keysMap[selectedKey].parent;\n    if (parentKey) {\n      openKey = parentKey;\n    }\n  }\n  return { selectedKey, openKey };\n};\nexport const handleDropdownNavigation = (e, dropdownIsOpen, menu, toggleDropdown, setSelectedKeys, setOpenKeys) => {\n  if (e.key === NAV_KEYS.tab && !dropdownIsOpen) {\n    return; // if tab, continue with system tab navigation\n  }\n  const menuProps = menu.props || {};\n  const keysMap = extractMenuItemsKeyMap(menuProps.children);\n  const keys = Object.keys(keysMap);\n  const { selectedKeys = [] } = menuProps;\n  const currentKeyIndex = keys.indexOf(selectedKeys[0]);\n  switch (e.key) {\n    // toggle the dropdown on keypress\n    case ACTION_KEYS.enter:\n    case ACTION_KEYS.spacebar:\n    case ACTION_KEYS.space:\n      if (selectedKeys.length) {\n        const currentKey = selectedKeys[0];\n        const currentKeyConf = keysMap[selectedKeys];\n        // when a menu item is selected, then trigger\n        // the menu item's onClick handler\n        menuProps.onClick == null ? void 0 : menuProps.onClick({ key: currentKey, domEvent: e });\n        // trigger click handle on ref\n        if (currentKeyConf != null && currentKeyConf.ref) {\n          const refMenuItemProps = currentKeyConf.ref.current.props;\n          refMenuItemProps.onClick == null ? void 0 : refMenuItemProps.onClick({\n            key: currentKey,\n            domEvent: e\n          });\n        }\n        // clear out/deselect keys\n        setSelectedKeys([]);\n        // close submenus\n        setOpenKeys([]);\n        // put focus back on menu trigger\n        e.currentTarget.focus();\n      }\n      // if nothing was selected, or after selecting new menu item,\n      toggleDropdown();\n      break;\n    // select the menu items going down\n    case NAV_KEYS.down:\n    case NAV_KEYS.tab && !e.shiftKey:{\n        const { selectedKey, openKey } = getNavigationKeys(keys, keysMap, currentKeyIndex, 'down');\n        setSelectedKeys([selectedKey]);\n        setOpenKeys(openKey ? [openKey] : []);\n        break;\n      }\n    // select the menu items going up\n    case NAV_KEYS.up:\n    case NAV_KEYS.tab && e.shiftKey:{\n        const { selectedKey, openKey } = getNavigationKeys(keys, keysMap, currentKeyIndex, 'up');\n        setSelectedKeys([selectedKey]);\n        setOpenKeys(openKey ? [openKey] : []);\n        break;\n      }\n    case NAV_KEYS.escape:\n      // close dropdown menu\n      toggleDropdown();\n      break;\n    default:\n      break;\n  }\n};\nconst ViewResultsModalTrigger = ({ canExplore, exploreUrl, triggerNode, modalTitle, modalBody, showModal = false, setShowModal }) => {\n  const history = useHistory();\n  const exploreChart = () => history.push(exploreUrl);\n  const theme = useTheme();\n  const openModal = useCallback(() => setShowModal(true), []);\n  const closeModal = useCallback(() => setShowModal(false), []);\n  return _jsxs(_Fragment, { children: [\n    _jsx(\"span\", { \"data-test\": \"span-modal-trigger\", onClick: openModal, role: \"button\", tabIndex: 0, children:\n      triggerNode }\n    ),\n    (() => _jsx(Modal, { css: css`\n            .ant-modal-body {\n              display: flex;\n              flex-direction: column;\n            }\n          `, show: showModal, onHide: closeModal, closable: true, title: modalTitle, footer: _jsxs(_Fragment, { children: [\n        _jsx(Button, { buttonStyle: \"secondary\", buttonSize: \"small\", onClick: exploreChart, disabled: !canExplore, tooltip: !canExplore ?\n          t('You do not have sufficient permissions to edit the chart') :\n          undefined, children:\n          t('Edit chart') }\n        ),\n        _jsx(Button, { buttonStyle: \"primary\", buttonSize: \"small\", onClick: closeModal, css: css`\n                  margin-left: ${theme.gridUnit * 2}px;\n                `, children:\n          t('Close') }\n        )] }\n      ), responsive: true, resizable: true, resizableConfig: {\n        minHeight: theme.gridUnit * 128,\n        minWidth: theme.gridUnit * 128,\n        defaultSize: {\n          width: 'auto',\n          height: '75vh'\n        }\n      }, draggable: true, destroyOnClose: true, children:\n      modalBody }\n    ))()] }\n  );\n};__signature__(ViewResultsModalTrigger, \"useHistory{history}\\nuseTheme{theme}\\nuseCallback{openModal}\\nuseCallback{closeModal}\", () => [useHistory, useTheme]);\nconst SliceHeaderControls = (props) => {var _getChartMetadataRegi, _getChartMetadataRegi2;\n  const [dropdownIsOpen, setDropdownIsOpen] = useState(false);\n  const [tableModalIsOpen, setTableModalIsOpen] = useState(false);\n  const [drillModalIsOpen, setDrillModalIsOpen] = useState(false);\n  const [selectedKeys, setSelectedKeys] = useState([]);\n  // setting openKeys undefined falls back to uncontrolled behaviour\n  const [openKeys, setOpenKeys] = useState(undefined);\n  const [openScopingModal, scopingModal] = useCrossFiltersScopingModal(props.slice.slice_id);\n  const history = useHistory();\n  const queryMenuRef = useRef(null);\n  const menuRef = useRef(null);\n  const copyLinkMenuRef = useRef(null);\n  const shareByEmailMenuRef = useRef(null);\n  const drillToDetailMenuRef = useRef(null);\n  const toggleDropdown = ({ close } = {}) => {\n    setDropdownIsOpen(!(close || dropdownIsOpen));\n    // clear selected keys\n    setSelectedKeys([]);\n    // clear out/deselect submenus\n    // setOpenKeys([]);\n  };\n  const canEditCrossFilters = useSelector(({ dashboardInfo }) => dashboardInfo.dash_edit_perm) &&\n  isFeatureEnabled(FeatureFlag.DashboardCrossFilters) && ((_getChartMetadataRegi =\n  getChartMetadataRegistry().\n  get(props.slice.viz_type)) == null ? void 0 : (_getChartMetadataRegi2 = _getChartMetadataRegi.\n  behaviors) == null ? void 0 : _getChartMetadataRegi2.includes(Behavior.InteractiveChart));\n  const canExplore = props.supersetCanExplore;\n  const canDatasourceSamples = useSelector((state) => {var _state$user;return findPermission('can_samples', 'Datasource', (_state$user = state.user) == null ? void 0 : _state$user.roles);});\n  const canDrill = useSelector((state) => {var _state$user2;return findPermission('can_drill', 'Dashboard', (_state$user2 = state.user) == null ? void 0 : _state$user2.roles);});\n  const canDrillToDetail = (canExplore || canDrill) && canDatasourceSamples;\n  const canViewQuery = useSelector((state) => {var _state$user3;return findPermission('can_view_query', 'Dashboard', (_state$user3 = state.user) == null ? void 0 : _state$user3.roles);});\n  const canViewTable = useSelector((state) => {var _state$user4;return findPermission('can_view_chart_as_table', 'Dashboard', (_state$user4 = state.user) == null ? void 0 : _state$user4.roles);});\n  const refreshChart = () => {\n    if (props.updatedDttm) {\n      props.forceRefresh(props.slice.slice_id, props.dashboardId);\n    }\n  };\n  const handleMenuClick = ({ key, domEvent }) => {\n    // close menu\n    toggleDropdown({ close: true });\n    switch (key) {\n      case MenuKeys.ForceRefresh:\n        refreshChart();\n        props.addSuccessToast(t('Data refreshed'));\n        break;\n      case MenuKeys.ToggleChartDescription:\n        // eslint-disable-next-line no-unused-expressions\n        props.toggleExpandSlice == null ? void 0 : props.toggleExpandSlice(props.slice.slice_id);\n        break;\n      case MenuKeys.ExploreChart:\n        // eslint-disable-next-line no-unused-expressions\n        props.logExploreChart == null ? void 0 : props.logExploreChart(props.slice.slice_id);\n        if (domEvent.metaKey || domEvent.ctrlKey) {\n          domEvent.preventDefault();\n          window.open(props.exploreUrl, '_blank');\n        } else\n        {\n          history.push(props.exploreUrl);\n        }\n        break;\n      case MenuKeys.ExportCsv:\n        // eslint-disable-next-line no-unused-expressions\n        props.exportCSV == null ? void 0 : props.exportCSV(props.slice.slice_id);\n        break;\n      case MenuKeys.ExportPivotCsv:\n        // eslint-disable-next-line no-unused-expressions\n        props.exportPivotCSV == null ? void 0 : props.exportPivotCSV(props.slice.slice_id);\n        break;\n      case MenuKeys.Fullscreen:\n        props.handleToggleFullSize();\n        break;\n      case MenuKeys.ExportFullCsv:\n        // eslint-disable-next-line no-unused-expressions\n        props.exportFullCSV == null ? void 0 : props.exportFullCSV(props.slice.slice_id);\n        break;\n      case MenuKeys.ExportFullXlsx:\n        // eslint-disable-next-line no-unused-expressions\n        props.exportFullXLSX == null ? void 0 : props.exportFullXLSX(props.slice.slice_id);\n        break;\n      case MenuKeys.ExportXlsx:\n        // eslint-disable-next-line no-unused-expressions\n        props.exportXLSX == null ? void 0 : props.exportXLSX(props.slice.slice_id);\n        break;\n      case MenuKeys.DownloadAsImage:{\n          // menu closes with a delay, we need to hide it manually,\n          // so that we don't capture it on the screenshot\n          const menu = document.querySelector('.ant-dropdown:not(.ant-dropdown-hidden)');\n          if (menu) {\n            menu.style.visibility = 'hidden';\n          }\n          downloadAsImage(getScreenshotNodeSelector(props.slice.slice_id), props.slice.slice_name, true)(domEvent).then(() => {\n            if (menu) {\n              menu.style.visibility = 'visible';\n            }\n          });\n          props.logEvent == null ? void 0 : props.logEvent(LOG_ACTIONS_CHART_DOWNLOAD_AS_IMAGE, {\n            chartId: props.slice.slice_id\n          });\n          break;\n        }\n      case MenuKeys.CrossFilterScoping:{\n          openScopingModal();\n          break;\n        }\n      case MenuKeys.ViewResults:{\n          if (!tableModalIsOpen) {\n            setTableModalIsOpen(true);\n          }\n          break;\n        }\n      case MenuKeys.DrillToDetail:{\n          setDrillModalIsOpen(!drillModalIsOpen);\n          break;\n        }\n      case MenuKeys.ViewQuery:{\n          if (queryMenuRef.current && !queryMenuRef.current.showModal) {\n            queryMenuRef.current.open(domEvent);\n          }\n          break;\n        }\n      default:\n        break;\n    }\n  };\n  const { componentId, dashboardId, slice, isFullSize, cachedDttm = [], updatedDttm = null, addSuccessToast = () => {}, addDangerToast = () => {}, supersetCanShare = false, isCached = [] } = props;\n  const isTable = slice.viz_type === 'table';\n  const isPivotTable = slice.viz_type === 'pivot_table_v2';\n  const cachedWhen = (cachedDttm || []).map((itemCachedDttm) => moment.utc(itemCachedDttm).fromNow());\n  const updatedWhen = updatedDttm ? moment.utc(updatedDttm).fromNow() : '';\n  const getCachedTitle = (itemCached) => {\n    if (itemCached) {\n      return t('Cached %s', cachedWhen);\n    }\n    if (updatedWhen) {\n      return t('Fetched %s', updatedWhen);\n    }\n    return '';\n  };\n  const refreshTooltipData = [...new Set(isCached.map(getCachedTitle) || '')];\n  // If all queries have same cache time we can unit them to one\n  const refreshTooltip = refreshTooltipData.map((item, index) => _jsx(\"div\", { children:\n    refreshTooltipData.length > 1 ?\n    t('Query %s: %s', index + 1, item) :\n    item }, `tooltip-${index}`\n  ));\n  const fullscreenLabel = isFullSize ?\n  t('Exit fullscreen') :\n  t('Enter fullscreen');\n  // @z-index-below-dashboard-header (100) - 1 = 99 for !isFullSize and 101 for isFullSize\n  const dropdownOverlayStyle = {\n    zIndex: isFullSize ? 101 : 99,\n    animationDuration: '0s'\n  };\n  // controlled/uncontrolled behaviour for submenus\n  const openKeysProps = {};\n  if (openKeys) {\n    openKeysProps.openKeys = openKeys;\n  }\n  const menu = _jsxs(Menu, { onClick: handleMenuClick, selectable: false, \"data-test\": `slice_${slice.slice_id}-menu`, selectedKeys: selectedKeys, id: `slice_${slice.slice_id}-menu`, ref: menuRef\n    // submenus must be rendered for handleDropdownNavigation\n    , forceSubMenuRender: true, ...openKeysProps, children: [\n    _jsxs(Menu.Item, { disabled: props.chartStatus === 'loading', style: { height: 'auto', lineHeight: 'initial' }, \"data-test\": \"refresh-chart-menu-item\", children: [\n      t('Force refresh'),\n      _jsx(RefreshTooltip, { \"data-test\": \"dashboard-slice-refresh-tooltip\", children:\n        refreshTooltip }\n      )] }, MenuKeys.ForceRefresh\n    ),\n\n    _jsx(Menu.Item, { children: fullscreenLabel }, MenuKeys.Fullscreen),\n\n    _jsx(Menu.Divider, {}),\n\n    slice.description && _jsx(Menu.Item, { children:\n      props.isDescriptionExpanded ?\n      t('Hide chart description') :\n      t('Show chart description') }, MenuKeys.ToggleChartDescription\n    ),\n\n    canExplore && _jsx(Menu.Item, { children:\n      _jsx(Tooltip, { title: getSliceHeaderTooltip(props.slice.slice_name), children:\n        t('Edit chart') }\n      ) }, MenuKeys.ExploreChart\n    ),\n\n    canEditCrossFilters && _jsx(Menu.Item, { children:\n      t('Cross-filtering scoping') }, MenuKeys.CrossFilterScoping\n    ),\n\n    (canExplore || canEditCrossFilters) && _jsx(Menu.Divider, {}),\n\n    (canExplore || canViewQuery) && _jsx(Menu.Item, { children:\n      _jsx(ModalTrigger, { triggerNode: _jsx(\"span\", { \"data-test\": \"view-query-menu-item\", children: t('View query') }), modalTitle: t('View query'), modalBody: _jsx(ViewQueryModal, { latestQueryFormData: props.formData }), draggable: true, resizable: true, responsive: true, ref: queryMenuRef }) }, MenuKeys.ViewQuery\n    ),\n\n    (canExplore || canViewTable) && _jsx(Menu.Item, { children:\n      _jsx(ViewResultsModalTrigger, { canExplore: props.supersetCanExplore, exploreUrl: props.exploreUrl, triggerNode: _jsx(\"span\", { \"data-test\": \"view-query-menu-item\", children: t('View as table') }), setShowModal: setTableModalIsOpen, showModal: tableModalIsOpen, modalTitle: t('Chart Data: %s', slice.slice_name), modalBody: _jsx(ResultsPaneOnDashboard, { queryFormData: props.formData, queryForce: false, dataSize: 20, isRequest: true, isVisible: true, canDownload: !!props.supersetCanCSV }) }) }, MenuKeys.ViewResults\n    ),\n\n    isFeatureEnabled(FeatureFlag.DrillToDetail) && canDrillToDetail && _jsx(DrillDetailMenuItems, { chartId: slice.slice_id, formData: props.formData, showModal: drillModalIsOpen, setShowModal: setDrillModalIsOpen, drillToDetailMenuRef: drillToDetailMenuRef }, MenuKeys.DrillToDetail),\n\n    (slice.description || canExplore) && _jsx(Menu.Divider, {}),\n\n    supersetCanShare && _jsx(Menu.SubMenu, { title: t('Share'),\n      // reset to uncontrolled behaviour\n      onTitleMouseEnter: () => setOpenKeys(undefined), children:\n      _jsx(ShareMenuItems, { dashboardId: dashboardId, dashboardComponentId: componentId, copyMenuItemTitle: t('Copy permalink to clipboard'), emailMenuItemTitle: t('Share chart by email'), emailSubject: t('Superset chart'), emailBody: t('Check out this chart: '), addSuccessToast: addSuccessToast, addDangerToast: addDangerToast, copyMenuItemRef: copyLinkMenuRef, shareByEmailMenuItemRef: shareByEmailMenuRef, selectedKeys: selectedKeys.filter((key) => key === MenuKeys.CopyLink || key === MenuKeys.ShareByEmail) }) }, MenuKeys.Share\n    ),\n\n    props.supersetCanCSV && _jsxs(Menu.SubMenu, { title: t('Download'), onTitleMouseEnter: () => setOpenKeys(undefined), children: [\n      _jsx(Menu.Item, { icon: _jsx(Icons.FileOutlined, { css: dropdownIconsStyles }), children:\n        t('Export to .CSV') }, MenuKeys.ExportCsv\n      ),\n      isPivotTable && _jsx(Menu.Item, { icon: _jsx(Icons.FileOutlined, { css: dropdownIconsStyles }), children:\n        t('Export to Pivoted .CSV') }, MenuKeys.ExportPivotCsv\n      ),\n      _jsx(Menu.Item, { icon: _jsx(Icons.FileOutlined, { css: dropdownIconsStyles }), children:\n        t('Export to Excel') }, MenuKeys.ExportXlsx\n      ),\n\n      isFeatureEnabled(FeatureFlag.AllowFullCsvExport) &&\n      props.supersetCanCSV &&\n      isTable && _jsxs(_Fragment, { children: [\n        _jsx(Menu.Item, { icon: _jsx(Icons.FileOutlined, { css: dropdownIconsStyles }), children:\n          t('Export to full .CSV') }, MenuKeys.ExportFullCsv\n        ),\n        _jsx(Menu.Item, { icon: _jsx(Icons.FileOutlined, { css: dropdownIconsStyles }), children:\n          t('Export to full Excel') }, MenuKeys.ExportFullXlsx\n        )] }\n      ),\n\n      _jsx(Menu.Item, { icon: _jsx(Icons.FileImageOutlined, { css: dropdownIconsStyles }), children:\n        t('Download as image') }, MenuKeys.DownloadAsImage\n      )] }, MenuKeys.Download\n    )] }\n  );\n  return _jsxs(_Fragment, { children: [\n    isFullSize && _jsx(Icons.FullscreenExitOutlined, { style: { fontSize: 22 }, onClick: () => {\n        props.handleToggleFullSize();\n      } }),\n    _jsx(NoAnimationDropdown, { overlay: menu, overlayStyle: dropdownOverlayStyle, trigger: ['click'], placement: \"bottomRight\", visible: dropdownIsOpen, onVisibleChange: (status) => toggleDropdown({ close: !status }), onKeyDown: (e) => handleDropdownNavigation(e, dropdownIsOpen, menu, toggleDropdown, setSelectedKeys, setOpenKeys), children:\n      _jsx(\"span\", { css: () => css`\n            display: flex;\n            align-items: center;\n          `, id: `slice_${slice.slice_id}-controls`, role: \"button\", \"aria-label\": \"More Options\", \"aria-haspopup\": \"true\", tabIndex: 0, children:\n        _jsx(VerticalDotsTrigger, {}) }\n      ) }\n    ),\n    canEditCrossFilters && scopingModal] }\n  );\n};__signature__(SliceHeaderControls, \"useState{[dropdownIsOpen, setDropdownIsOpen](false)}\\nuseState{[tableModalIsOpen, setTableModalIsOpen](false)}\\nuseState{[drillModalIsOpen, setDrillModalIsOpen](false)}\\nuseState{[selectedKeys, setSelectedKeys]([])}\\nuseState{[openKeys, setOpenKeys](undefined)}\\nuseCrossFiltersScopingModal{[openScopingModal, scopingModal]}\\nuseHistory{history}\\nuseRef{queryMenuRef}\\nuseRef{menuRef}\\nuseRef{copyLinkMenuRef}\\nuseRef{shareByEmailMenuRef}\\nuseRef{drillToDetailMenuRef}\\nuseSelector{}\\nuseSelector{canDatasourceSamples}\\nuseSelector{canDrill}\\nuseSelector{canViewQuery}\\nuseSelector{canViewTable}\", () => [useCrossFiltersScopingModal, useHistory, useSelector, useSelector, useSelector, useSelector, useSelector]);const _default =\nwithRouter(SliceHeaderControls);export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(ACTION_KEYS, \"ACTION_KEYS\", \"/app/superset-frontend/src/dashboard/components/SliceHeaderControls/index.tsx\");reactHotLoader.register(NAV_KEYS, \"NAV_KEYS\", \"/app/superset-frontend/src/dashboard/components/SliceHeaderControls/index.tsx\");reactHotLoader.register(VerticalDotsContainer, \"VerticalDotsContainer\", \"/app/superset-frontend/src/dashboard/components/SliceHeaderControls/index.tsx\");reactHotLoader.register(RefreshTooltip, \"RefreshTooltip\", \"/app/superset-frontend/src/dashboard/components/SliceHeaderControls/index.tsx\");reactHotLoader.register(getScreenshotNodeSelector, \"getScreenshotNodeSelector\", \"/app/superset-frontend/src/dashboard/components/SliceHeaderControls/index.tsx\");reactHotLoader.register(VerticalDotsTrigger, \"VerticalDotsTrigger\", \"/app/superset-frontend/src/dashboard/components/SliceHeaderControls/index.tsx\");reactHotLoader.register(dropdownIconsStyles, \"dropdownIconsStyles\", \"/app/superset-frontend/src/dashboard/components/SliceHeaderControls/index.tsx\");reactHotLoader.register(extractMenuItemRefs, \"extractMenuItemRefs\", \"/app/superset-frontend/src/dashboard/components/SliceHeaderControls/index.tsx\");reactHotLoader.register(extractMenuItemsKeys, \"extractMenuItemsKeys\", \"/app/superset-frontend/src/dashboard/components/SliceHeaderControls/index.tsx\");reactHotLoader.register(extractMenuItemsKeyMap, \"extractMenuItemsKeyMap\", \"/app/superset-frontend/src/dashboard/components/SliceHeaderControls/index.tsx\");reactHotLoader.register(getNavigationKeys, \"getNavigationKeys\", \"/app/superset-frontend/src/dashboard/components/SliceHeaderControls/index.tsx\");reactHotLoader.register(handleDropdownNavigation, \"handleDropdownNavigation\", \"/app/superset-frontend/src/dashboard/components/SliceHeaderControls/index.tsx\");reactHotLoader.register(ViewResultsModalTrigger, \"ViewResultsModalTrigger\", \"/app/superset-frontend/src/dashboard/components/SliceHeaderControls/index.tsx\");reactHotLoader.register(SliceHeaderControls, \"SliceHeaderControls\", \"/app/superset-frontend/src/dashboard/components/SliceHeaderControls/index.tsx\");reactHotLoader.register(_default, \"default\", \"/app/superset-frontend/src/dashboard/components/SliceHeaderControls/index.tsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"names":["useState","useRef","useCallback","useHistory","withRouter","moment","Behavior","css","isFeatureEnabled","FeatureFlag","getChartMetadataRegistry","styled","t","useTheme","ensureIsArray","useSelector","MenuItemKeyEnum","Menu","isAntdMenuItem","isAntdMenuItemRef","isSubMenuOrItemType","isAntdMenuSubmenu","NoAnimationDropdown","ShareMenuItems","downloadAsImage","getSliceHeaderTooltip","Tooltip","Icons","ModalTrigger","Button","ViewQueryModal","ResultsPaneOnDashboard","Modal","DrillDetailMenuItems","LOG_ACTIONS_CHART_DOWNLOAD_AS_IMAGE","MenuKeys","findPermission","useCrossFiltersScopingModal","jsx","_jsx","jsxs","_jsxs","Fragment","_Fragment","ACTION_KEYS","enter","spacebar","space","NAV_KEYS","tab","escape","up","down","VerticalDotsContainer","div","theme","gridUnit","colors","text","label","RefreshTooltip","grayscale","base","getScreenshotNodeSelector","chartId","VerticalDotsTrigger","children","className","dropdownIconsStyles","extractMenuItemRefs","child","childProps","props","arrayProps","Object","values","refs","filter","ref","extractMenuItemsKeys","currentKeys","allKeys","arrayChildren","forEach","_child$props","isMenuItem","key","push","length","map","current","eventKey","childKeys","extractMenuItemsKeyMap","keysMap","childrenArray","_child$props2","isSubmenu","menuItemsRefs","directKey","type","SubMenu","MenuItem","parent","_child$props3","theChildren","keyMap","k","SubMenuItem","getNavigationKeys","keys","currentKeyIndex","direction","_keysMap$selectedKey","step","skipStep","keysLen","mathFn","Math","max","min","openKey","selectedKey","undefined","isSubMenu","parentKey","handleDropdownNavigation","e","dropdownIsOpen","menu","toggleDropdown","setSelectedKeys","setOpenKeys","menuProps","selectedKeys","indexOf","currentKey","currentKeyConf","onClick","domEvent","refMenuItemProps","currentTarget","focus","shiftKey","ViewResultsModalTrigger","canExplore","exploreUrl","triggerNode","modalTitle","modalBody","showModal","setShowModal","history","exploreChart","openModal","closeModal","role","tabIndex","show","onHide","closable","title","footer","buttonStyle","buttonSize","disabled","tooltip","responsive","resizable","resizableConfig","minHeight","minWidth","defaultSize","width","height","draggable","destroyOnClose","__signature__","SliceHeaderControls","_getChartMetadataRegi","_getChartMetadataRegi2","setDropdownIsOpen","tableModalIsOpen","setTableModalIsOpen","drillModalIsOpen","setDrillModalIsOpen","openKeys","openScopingModal","scopingModal","slice","slice_id","queryMenuRef","menuRef","copyLinkMenuRef","shareByEmailMenuRef","drillToDetailMenuRef","close","canEditCrossFilters","dashboardInfo","dash_edit_perm","DashboardCrossFilters","get","viz_type","behaviors","includes","InteractiveChart","supersetCanExplore","canDatasourceSamples","state","_state$user","user","roles","canDrill","_state$user2","canDrillToDetail","canViewQuery","_state$user3","canViewTable","_state$user4","refreshChart","updatedDttm","forceRefresh","dashboardId","handleMenuClick","ForceRefresh","addSuccessToast","ToggleChartDescription","toggleExpandSlice","ExploreChart","logExploreChart","metaKey","ctrlKey","preventDefault","window","open","ExportCsv","exportCSV","ExportPivotCsv","exportPivotCSV","Fullscreen","handleToggleFullSize","ExportFullCsv","exportFullCSV","ExportFullXlsx","exportFullXLSX","ExportXlsx","exportXLSX","DownloadAsImage","document","querySelector","style","visibility","slice_name","then","logEvent","CrossFilterScoping","ViewResults","DrillToDetail","ViewQuery","componentId","isFullSize","cachedDttm","addDangerToast","supersetCanShare","isCached","isTable","isPivotTable","cachedWhen","itemCachedDttm","utc","fromNow","updatedWhen","getCachedTitle","itemCached","refreshTooltipData","Set","refreshTooltip","item","index","fullscreenLabel","dropdownOverlayStyle","zIndex","animationDuration","openKeysProps","selectable","id","forceSubMenuRender","Item","chartStatus","lineHeight","Divider","description","isDescriptionExpanded","latestQueryFormData","formData","queryFormData","queryForce","dataSize","isRequest","isVisible","canDownload","supersetCanCSV","onTitleMouseEnter","dashboardComponentId","copyMenuItemTitle","emailMenuItemTitle","emailSubject","emailBody","copyMenuItemRef","shareByEmailMenuItemRef","CopyLink","ShareByEmail","Share","icon","FileOutlined","AllowFullCsvExport","FileImageOutlined","Download","FullscreenExitOutlined","fontSize","overlay","overlayStyle","trigger","placement","visible","onVisibleChange","status","onKeyDown","_default","reactHotLoader","reactHotLoaderGlobal","default","register","leaveModule","module"],"sources":["/app/superset-frontend/src/dashboard/components/SliceHeaderControls/index.tsx"],"sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport {\n  MouseEvent,\n  Key,\n  KeyboardEvent,\n  ReactChild,\n  useState,\n  useRef,\n  RefObject,\n  useCallback,\n  ReactElement,\n} from 'react';\n\nimport { RouteComponentProps, useHistory, withRouter } from 'react-router-dom';\nimport moment from 'moment';\nimport {\n  Behavior,\n  css,\n  isFeatureEnabled,\n  FeatureFlag,\n  getChartMetadataRegistry,\n  QueryFormData,\n  styled,\n  t,\n  useTheme,\n  ensureIsArray,\n} from '@superset-ui/core';\nimport { useSelector } from 'react-redux';\nimport {\n  MenuItemKeyEnum,\n  Menu,\n  MenuItemChildType,\n  isAntdMenuItem,\n  isAntdMenuItemRef,\n  isSubMenuOrItemType,\n  isAntdMenuSubmenu,\n} from 'src/components/Menu';\nimport { NoAnimationDropdown } from 'src/components/Dropdown';\nimport ShareMenuItems from 'src/dashboard/components/menu/ShareMenuItems';\nimport downloadAsImage from 'src/utils/downloadAsImage';\nimport { getSliceHeaderTooltip } from 'src/dashboard/util/getSliceHeaderTooltip';\nimport { Tooltip } from 'src/components/Tooltip';\nimport Icons from 'src/components/Icons';\nimport ModalTrigger from 'src/components/ModalTrigger';\nimport Button from 'src/components/Button';\nimport ViewQueryModal from 'src/explore/components/controls/ViewQueryModal';\nimport { ResultsPaneOnDashboard } from 'src/explore/components/DataTablesPane';\nimport Modal from 'src/components/Modal';\nimport { DrillDetailMenuItems } from 'src/components/Chart/DrillDetail';\nimport { LOG_ACTIONS_CHART_DOWNLOAD_AS_IMAGE } from 'src/logger/LogUtils';\nimport { MenuKeys, RootState } from 'src/dashboard/types';\nimport { findPermission } from 'src/utils/findPermission';\nimport { useCrossFiltersScopingModal } from '../nativeFilters/FilterBar/CrossFilters/ScopingModal/useCrossFiltersScopingModal';\n\nconst ACTION_KEYS = {\n  enter: 'Enter',\n  spacebar: 'Spacebar',\n  space: ' ',\n};\n\nconst NAV_KEYS = {\n  tab: 'Tab',\n  escape: 'Escape',\n  up: 'ArrowUp',\n  down: 'ArrowDown',\n};\n\n// TODO: replace 3 dots with an icon\nconst VerticalDotsContainer = styled.div`\n  padding: ${({ theme }) => theme.gridUnit / 4}px\n    ${({ theme }) => theme.gridUnit * 1.5}px;\n\n  .dot {\n    display: block;\n\n    height: ${({ theme }) => theme.gridUnit}px;\n    width: ${({ theme }) => theme.gridUnit}px;\n    border-radius: 50%;\n    margin: ${({ theme }) => theme.gridUnit / 2}px 0;\n\n    background-color: ${({ theme }) => theme.colors.text.label};\n  }\n\n  &:hover {\n    cursor: pointer;\n  }\n`;\n\nconst RefreshTooltip = styled.div`\n  height: auto;\n  margin: ${({ theme }) => theme.gridUnit}px 0;\n  color: ${({ theme }) => theme.colors.grayscale.base};\n  line-height: 21px;\n  display: flex;\n  flex-direction: column;\n  align-items: flex-start;\n  justify-content: flex-start;\n`;\n\nconst getScreenshotNodeSelector = (chartId: string | number) =>\n  `.dashboard-chart-id-${chartId}`;\n\nconst VerticalDotsTrigger = () => (\n  <VerticalDotsContainer>\n    <span className=\"dot\" />\n    <span className=\"dot\" />\n    <span className=\"dot\" />\n  </VerticalDotsContainer>\n);\n\nexport interface SliceHeaderControlsProps {\n  slice: {\n    description: string;\n    viz_type: string;\n    slice_name: string;\n    slice_id: number;\n    slice_description: string;\n    datasource: string;\n  };\n\n  componentId: string;\n  dashboardId: number;\n  chartStatus: string;\n  isCached: boolean[];\n  cachedDttm: string[] | null;\n  isExpanded?: boolean;\n  updatedDttm: number | null;\n  isFullSize?: boolean;\n  isDescriptionExpanded?: boolean;\n  formData: QueryFormData;\n  exploreUrl: string;\n\n  forceRefresh: (sliceId: number, dashboardId: number) => void;\n  logExploreChart?: (sliceId: number) => void;\n  logEvent?: (eventName: string, eventData?: object) => void;\n  toggleExpandSlice?: (sliceId: number) => void;\n  exportCSV?: (sliceId: number) => void;\n  exportPivotCSV?: (sliceId: number) => void;\n  exportFullCSV?: (sliceId: number) => void;\n  exportXLSX?: (sliceId: number) => void;\n  exportFullXLSX?: (sliceId: number) => void;\n  handleToggleFullSize: () => void;\n\n  addDangerToast: (message: string) => void;\n  addSuccessToast: (message: string) => void;\n\n  supersetCanExplore?: boolean;\n  supersetCanShare?: boolean;\n  supersetCanCSV?: boolean;\n\n  crossFiltersEnabled?: boolean;\n}\ntype SliceHeaderControlsPropsWithRouter = SliceHeaderControlsProps &\n  RouteComponentProps;\n\nconst dropdownIconsStyles = css`\n  &&.anticon > .anticon:first-child {\n    margin-right: 0;\n    vertical-align: 0;\n  }\n`;\n\n/**\n * A MenuItem can be recognized in the tree by the presence of a ref\n *\n * @param children\n * @param currentKeys\n * @returns an array of keys\n */\nconst extractMenuItemRefs = (child: MenuItemChildType): RefObject<any>[] => {\n  // check that child has props\n  const childProps: Record<string, any> = child?.props;\n  // loop through each prop\n  if (childProps) {\n    const arrayProps = Object.values(childProps);\n    // check if any is of type ref MenuItem\n    const refs = arrayProps.filter(ref => isAntdMenuItemRef(ref));\n    return refs;\n  }\n  return [];\n};\n/**\n * Recursively extracts keys from menu items\n *\n * @param children\n * @param currentKeys\n * @returns an array of keys and their refs\n *\n */\nconst extractMenuItemsKeys = (\n  children: MenuItemChildType[],\n  currentKeys?: { key: string; ref?: RefObject<any> }[],\n): { key: string; ref?: RefObject<any> }[] => {\n  const allKeys = currentKeys || [];\n  const arrayChildren = ensureIsArray(children);\n\n  arrayChildren.forEach((child: MenuItemChildType) => {\n    const isMenuItem = isAntdMenuItem(child);\n    const refs = extractMenuItemRefs(child);\n    // key is immediately available in a standard MenuItem\n    if (isMenuItem) {\n      const { key } = child;\n      if (key) {\n        allKeys.push({\n          key,\n        });\n      }\n    }\n    // one or more menu items refs are available\n    if (refs.length) {\n      allKeys.push(\n        ...refs.map(ref => ({ key: ref.current.props.eventKey, ref })),\n      );\n    }\n\n    // continue to extract keys from nested children\n    if (child?.props?.children) {\n      const childKeys = extractMenuItemsKeys(child.props.children, allKeys);\n      allKeys.push(...childKeys);\n    }\n  });\n\n  return allKeys;\n};\n\n/**\n * Generates a map of keys and their types for a MenuItem\n * Individual refs can be given to extract keys from nested items\n * Refs can be used to control the event handlers of the menu items\n *\n * @param itemChildren\n * @param type\n * @returns a map of keys and their types\n */\nconst extractMenuItemsKeyMap = (\n  children: MenuItemChildType,\n): Record<string, any> => {\n  const keysMap: Record<string, any> = {};\n  const childrenArray = ensureIsArray(children);\n\n  childrenArray.forEach((child: MenuItemChildType) => {\n    const isMenuItem = isAntdMenuItem(child);\n    const isSubmenu = isAntdMenuSubmenu(child);\n    const menuItemsRefs = extractMenuItemRefs(child);\n\n    // key is immediately available in MenuItem or SubMenu\n    if (isMenuItem || isSubmenu) {\n      const directKey = child?.key;\n      if (directKey) {\n        keysMap[directKey] = {};\n        keysMap[directKey].type = isSubmenu\n          ? MenuItemKeyEnum.SubMenu\n          : MenuItemKeyEnum.MenuItem;\n      }\n    }\n\n    // one or more menu items refs are available\n    if (menuItemsRefs.length) {\n      menuItemsRefs.forEach(ref => {\n        const key = ref.current.props.eventKey;\n        keysMap[key] = {};\n        keysMap[key].type = isSubmenu\n          ? MenuItemKeyEnum.SubMenu\n          : MenuItemKeyEnum.MenuItem;\n        keysMap[key].parent = child.key;\n        keysMap[key].ref = ref;\n      });\n    }\n\n    // if it has children must check for the presence of menu items\n    if (child?.props?.children) {\n      const theChildren = child?.props?.children;\n      const childKeys = extractMenuItemsKeys(theChildren);\n      childKeys.forEach(keyMap => {\n        const k = keyMap.key;\n        keysMap[k] = {};\n        keysMap[k].type = MenuItemKeyEnum.SubMenuItem;\n        keysMap[k].parent = child.key;\n        if (keyMap.ref) {\n          keysMap[k].ref = keyMap.ref;\n        }\n      });\n    }\n  });\n\n  return keysMap;\n};\n\n/**\n *\n * Determines the next key to select based on the current key and direction\n *\n * @param keys\n * @param keysMap\n * @param currentKeyIndex\n * @param direction\n * @returns the selected key and the open key\n */\nconst getNavigationKeys = (\n  keys: string[],\n  keysMap: Record<string, any>,\n  currentKeyIndex: number,\n  direction = 'up',\n) => {\n  const step = direction === 'up' ? -1 : 1;\n  const skipStep = direction === 'up' ? -2 : 2;\n  const keysLen = direction === 'up' ? 0 : keys.length;\n  const mathFn = direction === 'up' ? Math.max : Math.min;\n  let openKey: string | undefined;\n  let selectedKey = keys[mathFn(currentKeyIndex + step, keysLen)];\n\n  // go to first key if current key is the last\n  if (!selectedKey) {\n    return { selectedKey: keys[0], openKey: undefined };\n  }\n\n  const isSubMenu = keysMap[selectedKey]?.type === MenuItemKeyEnum.SubMenu;\n  if (isSubMenu) {\n    // this is a submenu, skip to first submenu item\n    selectedKey = keys[mathFn(currentKeyIndex + skipStep, keysLen)];\n  }\n  // re-evaulate if current selected key is a submenu or submenu item\n  if (!isSubMenuOrItemType(keysMap[selectedKey].type)) {\n    openKey = undefined;\n  } else {\n    const parentKey = keysMap[selectedKey].parent;\n    if (parentKey) {\n      openKey = parentKey;\n    }\n  }\n  return { selectedKey, openKey };\n};\n\nexport const handleDropdownNavigation = (\n  e: KeyboardEvent<HTMLElement>,\n  dropdownIsOpen: boolean,\n  menu: ReactElement,\n  toggleDropdown: () => void,\n  setSelectedKeys: (keys: string[]) => void,\n  setOpenKeys: (keys: string[]) => void,\n) => {\n  if (e.key === NAV_KEYS.tab && !dropdownIsOpen) {\n    return; // if tab, continue with system tab navigation\n  }\n  const menuProps = menu.props || {};\n  const keysMap = extractMenuItemsKeyMap(menuProps.children);\n  const keys = Object.keys(keysMap);\n  const { selectedKeys = [] } = menuProps;\n  const currentKeyIndex = keys.indexOf(selectedKeys[0]);\n\n  switch (e.key) {\n    // toggle the dropdown on keypress\n    case ACTION_KEYS.enter:\n    case ACTION_KEYS.spacebar:\n    case ACTION_KEYS.space:\n      if (selectedKeys.length) {\n        const currentKey = selectedKeys[0];\n        const currentKeyConf = keysMap[selectedKeys];\n        // when a menu item is selected, then trigger\n        // the menu item's onClick handler\n        menuProps.onClick?.({ key: currentKey, domEvent: e });\n        // trigger click handle on ref\n        if (currentKeyConf?.ref) {\n          const refMenuItemProps = currentKeyConf.ref.current.props;\n          refMenuItemProps.onClick?.({\n            key: currentKey,\n            domEvent: e,\n          });\n        }\n        // clear out/deselect keys\n        setSelectedKeys([]);\n        // close submenus\n        setOpenKeys([]);\n        // put focus back on menu trigger\n        e.currentTarget.focus();\n      }\n      // if nothing was selected, or after selecting new menu item,\n      toggleDropdown();\n      break;\n    // select the menu items going down\n    case NAV_KEYS.down:\n    case NAV_KEYS.tab && !e.shiftKey: {\n      const { selectedKey, openKey } = getNavigationKeys(\n        keys,\n        keysMap,\n        currentKeyIndex,\n        'down',\n      );\n      setSelectedKeys([selectedKey]);\n      setOpenKeys(openKey ? [openKey] : []);\n      break;\n    }\n    // select the menu items going up\n    case NAV_KEYS.up:\n    case NAV_KEYS.tab && e.shiftKey: {\n      const { selectedKey, openKey } = getNavigationKeys(\n        keys,\n        keysMap,\n        currentKeyIndex,\n        'up',\n      );\n      setSelectedKeys([selectedKey]);\n      setOpenKeys(openKey ? [openKey] : []);\n      break;\n    }\n    case NAV_KEYS.escape:\n      // close dropdown menu\n      toggleDropdown();\n      break;\n    default:\n      break;\n  }\n};\n\nconst ViewResultsModalTrigger = ({\n  canExplore,\n  exploreUrl,\n  triggerNode,\n  modalTitle,\n  modalBody,\n  showModal = false,\n  setShowModal,\n}: {\n  canExplore?: boolean;\n  exploreUrl: string;\n  triggerNode: ReactChild;\n  modalTitle: ReactChild;\n  modalBody: ReactChild;\n  showModal: boolean;\n  setShowModal: (showModal: boolean) => void;\n}) => {\n  const history = useHistory();\n  const exploreChart = () => history.push(exploreUrl);\n  const theme = useTheme();\n  const openModal = useCallback(() => setShowModal(true), []);\n  const closeModal = useCallback(() => setShowModal(false), []);\n\n  return (\n    <>\n      <span\n        data-test=\"span-modal-trigger\"\n        onClick={openModal}\n        role=\"button\"\n        tabIndex={0}\n      >\n        {triggerNode}\n      </span>\n      {(() => (\n        <Modal\n          css={css`\n            .ant-modal-body {\n              display: flex;\n              flex-direction: column;\n            }\n          `}\n          show={showModal}\n          onHide={closeModal}\n          closable\n          title={modalTitle}\n          footer={\n            <>\n              <Button\n                buttonStyle=\"secondary\"\n                buttonSize=\"small\"\n                onClick={exploreChart}\n                disabled={!canExplore}\n                tooltip={\n                  !canExplore\n                    ? t(\n                        'You do not have sufficient permissions to edit the chart',\n                      )\n                    : undefined\n                }\n              >\n                {t('Edit chart')}\n              </Button>\n              <Button\n                buttonStyle=\"primary\"\n                buttonSize=\"small\"\n                onClick={closeModal}\n                css={css`\n                  margin-left: ${theme.gridUnit * 2}px;\n                `}\n              >\n                {t('Close')}\n              </Button>\n            </>\n          }\n          responsive\n          resizable\n          resizableConfig={{\n            minHeight: theme.gridUnit * 128,\n            minWidth: theme.gridUnit * 128,\n            defaultSize: {\n              width: 'auto',\n              height: '75vh',\n            },\n          }}\n          draggable\n          destroyOnClose\n        >\n          {modalBody}\n        </Modal>\n      ))()}\n    </>\n  );\n};\n\nconst SliceHeaderControls = (props: SliceHeaderControlsPropsWithRouter) => {\n  const [dropdownIsOpen, setDropdownIsOpen] = useState(false);\n  const [tableModalIsOpen, setTableModalIsOpen] = useState(false);\n  const [drillModalIsOpen, setDrillModalIsOpen] = useState(false);\n  const [selectedKeys, setSelectedKeys] = useState<string[]>([]);\n  // setting openKeys undefined falls back to uncontrolled behaviour\n  const [openKeys, setOpenKeys] = useState<string[] | undefined>(undefined);\n  const [openScopingModal, scopingModal] = useCrossFiltersScopingModal(\n    props.slice.slice_id,\n  );\n  const history = useHistory();\n\n  const queryMenuRef: RefObject<any> = useRef(null);\n  const menuRef: RefObject<any> = useRef(null);\n  const copyLinkMenuRef: RefObject<any> = useRef(null);\n  const shareByEmailMenuRef: RefObject<any> = useRef(null);\n  const drillToDetailMenuRef: RefObject<any> = useRef(null);\n\n  const toggleDropdown = ({ close }: { close?: boolean } = {}) => {\n    setDropdownIsOpen(!(close || dropdownIsOpen));\n    // clear selected keys\n    setSelectedKeys([]);\n    // clear out/deselect submenus\n    // setOpenKeys([]);\n  };\n\n  const canEditCrossFilters =\n    useSelector<RootState, boolean>(\n      ({ dashboardInfo }) => dashboardInfo.dash_edit_perm,\n    ) &&\n    isFeatureEnabled(FeatureFlag.DashboardCrossFilters) &&\n    getChartMetadataRegistry()\n      .get(props.slice.viz_type)\n      ?.behaviors?.includes(Behavior.InteractiveChart);\n  const canExplore = props.supersetCanExplore;\n  const canDatasourceSamples = useSelector((state: RootState) =>\n    findPermission('can_samples', 'Datasource', state.user?.roles),\n  );\n  const canDrill = useSelector((state: RootState) =>\n    findPermission('can_drill', 'Dashboard', state.user?.roles),\n  );\n  const canDrillToDetail = (canExplore || canDrill) && canDatasourceSamples;\n  const canViewQuery = useSelector((state: RootState) =>\n    findPermission('can_view_query', 'Dashboard', state.user?.roles),\n  );\n  const canViewTable = useSelector((state: RootState) =>\n    findPermission('can_view_chart_as_table', 'Dashboard', state.user?.roles),\n  );\n  const refreshChart = () => {\n    if (props.updatedDttm) {\n      props.forceRefresh(props.slice.slice_id, props.dashboardId);\n    }\n  };\n\n  const handleMenuClick = ({\n    key,\n    domEvent,\n  }: {\n    key: Key;\n    domEvent: MouseEvent<HTMLElement>;\n  }) => {\n    // close menu\n    toggleDropdown({ close: true });\n    switch (key) {\n      case MenuKeys.ForceRefresh:\n        refreshChart();\n        props.addSuccessToast(t('Data refreshed'));\n        break;\n      case MenuKeys.ToggleChartDescription:\n        // eslint-disable-next-line no-unused-expressions\n        props.toggleExpandSlice?.(props.slice.slice_id);\n        break;\n      case MenuKeys.ExploreChart:\n        // eslint-disable-next-line no-unused-expressions\n        props.logExploreChart?.(props.slice.slice_id);\n        if (domEvent.metaKey || domEvent.ctrlKey) {\n          domEvent.preventDefault();\n          window.open(props.exploreUrl, '_blank');\n        } else {\n          history.push(props.exploreUrl);\n        }\n        break;\n      case MenuKeys.ExportCsv:\n        // eslint-disable-next-line no-unused-expressions\n        props.exportCSV?.(props.slice.slice_id);\n        break;\n      case MenuKeys.ExportPivotCsv:\n        // eslint-disable-next-line no-unused-expressions\n        props.exportPivotCSV?.(props.slice.slice_id);\n        break;\n      case MenuKeys.Fullscreen:\n        props.handleToggleFullSize();\n        break;\n      case MenuKeys.ExportFullCsv:\n        // eslint-disable-next-line no-unused-expressions\n        props.exportFullCSV?.(props.slice.slice_id);\n        break;\n      case MenuKeys.ExportFullXlsx:\n        // eslint-disable-next-line no-unused-expressions\n        props.exportFullXLSX?.(props.slice.slice_id);\n        break;\n      case MenuKeys.ExportXlsx:\n        // eslint-disable-next-line no-unused-expressions\n        props.exportXLSX?.(props.slice.slice_id);\n        break;\n      case MenuKeys.DownloadAsImage: {\n        // menu closes with a delay, we need to hide it manually,\n        // so that we don't capture it on the screenshot\n        const menu = document.querySelector(\n          '.ant-dropdown:not(.ant-dropdown-hidden)',\n        ) as HTMLElement;\n        if (menu) {\n          menu.style.visibility = 'hidden';\n        }\n        downloadAsImage(\n          getScreenshotNodeSelector(props.slice.slice_id),\n          props.slice.slice_name,\n          true,\n          // @ts-ignore\n        )(domEvent).then(() => {\n          if (menu) {\n            menu.style.visibility = 'visible';\n          }\n        });\n        props.logEvent?.(LOG_ACTIONS_CHART_DOWNLOAD_AS_IMAGE, {\n          chartId: props.slice.slice_id,\n        });\n        break;\n      }\n      case MenuKeys.CrossFilterScoping: {\n        openScopingModal();\n        break;\n      }\n      case MenuKeys.ViewResults: {\n        if (!tableModalIsOpen) {\n          setTableModalIsOpen(true);\n        }\n        break;\n      }\n      case MenuKeys.DrillToDetail: {\n        setDrillModalIsOpen(!drillModalIsOpen);\n        break;\n      }\n      case MenuKeys.ViewQuery: {\n        if (queryMenuRef.current && !queryMenuRef.current.showModal) {\n          queryMenuRef.current.open(domEvent);\n        }\n        break;\n      }\n      default:\n        break;\n    }\n  };\n\n  const {\n    componentId,\n    dashboardId,\n    slice,\n    isFullSize,\n    cachedDttm = [],\n    updatedDttm = null,\n    addSuccessToast = () => {},\n    addDangerToast = () => {},\n    supersetCanShare = false,\n    isCached = [],\n  } = props;\n  const isTable = slice.viz_type === 'table';\n  const isPivotTable = slice.viz_type === 'pivot_table_v2';\n  const cachedWhen = (cachedDttm || []).map(itemCachedDttm =>\n    moment.utc(itemCachedDttm).fromNow(),\n  );\n  const updatedWhen = updatedDttm ? moment.utc(updatedDttm).fromNow() : '';\n  const getCachedTitle = (itemCached: boolean) => {\n    if (itemCached) {\n      return t('Cached %s', cachedWhen);\n    }\n    if (updatedWhen) {\n      return t('Fetched %s', updatedWhen);\n    }\n    return '';\n  };\n  const refreshTooltipData = [...new Set(isCached.map(getCachedTitle) || '')];\n  // If all queries have same cache time we can unit them to one\n  const refreshTooltip = refreshTooltipData.map((item, index) => (\n    <div key={`tooltip-${index}`}>\n      {refreshTooltipData.length > 1\n        ? t('Query %s: %s', index + 1, item)\n        : item}\n    </div>\n  ));\n  const fullscreenLabel = isFullSize\n    ? t('Exit fullscreen')\n    : t('Enter fullscreen');\n\n  // @z-index-below-dashboard-header (100) - 1 = 99 for !isFullSize and 101 for isFullSize\n  const dropdownOverlayStyle = {\n    zIndex: isFullSize ? 101 : 99,\n    animationDuration: '0s',\n  };\n\n  // controlled/uncontrolled behaviour for submenus\n  const openKeysProps: Record<string, string[]> = {};\n  if (openKeys) {\n    openKeysProps.openKeys = openKeys;\n  }\n\n  const menu = (\n    <Menu\n      onClick={handleMenuClick}\n      selectable={false}\n      data-test={`slice_${slice.slice_id}-menu`}\n      selectedKeys={selectedKeys}\n      id={`slice_${slice.slice_id}-menu`}\n      ref={menuRef}\n      // submenus must be rendered for handleDropdownNavigation\n      forceSubMenuRender\n      {...openKeysProps}\n    >\n      <Menu.Item\n        key={MenuKeys.ForceRefresh}\n        disabled={props.chartStatus === 'loading'}\n        style={{ height: 'auto', lineHeight: 'initial' }}\n        data-test=\"refresh-chart-menu-item\"\n      >\n        {t('Force refresh')}\n        <RefreshTooltip data-test=\"dashboard-slice-refresh-tooltip\">\n          {refreshTooltip}\n        </RefreshTooltip>\n      </Menu.Item>\n\n      <Menu.Item key={MenuKeys.Fullscreen}>{fullscreenLabel}</Menu.Item>\n\n      <Menu.Divider />\n\n      {slice.description && (\n        <Menu.Item key={MenuKeys.ToggleChartDescription}>\n          {props.isDescriptionExpanded\n            ? t('Hide chart description')\n            : t('Show chart description')}\n        </Menu.Item>\n      )}\n\n      {canExplore && (\n        <Menu.Item key={MenuKeys.ExploreChart}>\n          <Tooltip title={getSliceHeaderTooltip(props.slice.slice_name)}>\n            {t('Edit chart')}\n          </Tooltip>\n        </Menu.Item>\n      )}\n\n      {canEditCrossFilters && (\n        <Menu.Item key={MenuKeys.CrossFilterScoping}>\n          {t('Cross-filtering scoping')}\n        </Menu.Item>\n      )}\n\n      {(canExplore || canEditCrossFilters) && <Menu.Divider />}\n\n      {(canExplore || canViewQuery) && (\n        <Menu.Item key={MenuKeys.ViewQuery}>\n          <ModalTrigger\n            triggerNode={\n              <span data-test=\"view-query-menu-item\">{t('View query')}</span>\n            }\n            modalTitle={t('View query')}\n            modalBody={<ViewQueryModal latestQueryFormData={props.formData} />}\n            draggable\n            resizable\n            responsive\n            ref={queryMenuRef}\n          />\n        </Menu.Item>\n      )}\n\n      {(canExplore || canViewTable) && (\n        <Menu.Item key={MenuKeys.ViewResults}>\n          <ViewResultsModalTrigger\n            canExplore={props.supersetCanExplore}\n            exploreUrl={props.exploreUrl}\n            triggerNode={\n              <span data-test=\"view-query-menu-item\">{t('View as table')}</span>\n            }\n            setShowModal={setTableModalIsOpen}\n            showModal={tableModalIsOpen}\n            modalTitle={t('Chart Data: %s', slice.slice_name)}\n            modalBody={\n              <ResultsPaneOnDashboard\n                queryFormData={props.formData}\n                queryForce={false}\n                dataSize={20}\n                isRequest\n                isVisible\n                canDownload={!!props.supersetCanCSV}\n              />\n            }\n          />\n        </Menu.Item>\n      )}\n\n      {isFeatureEnabled(FeatureFlag.DrillToDetail) && canDrillToDetail && (\n        <DrillDetailMenuItems\n          chartId={slice.slice_id}\n          formData={props.formData}\n          key={MenuKeys.DrillToDetail}\n          showModal={drillModalIsOpen}\n          setShowModal={setDrillModalIsOpen}\n          drillToDetailMenuRef={drillToDetailMenuRef}\n        />\n      )}\n\n      {(slice.description || canExplore) && <Menu.Divider />}\n\n      {supersetCanShare && (\n        <Menu.SubMenu\n          title={t('Share')}\n          key={MenuKeys.Share}\n          // reset to uncontrolled behaviour\n          onTitleMouseEnter={() => setOpenKeys(undefined)}\n        >\n          <ShareMenuItems\n            dashboardId={dashboardId}\n            dashboardComponentId={componentId}\n            copyMenuItemTitle={t('Copy permalink to clipboard')}\n            emailMenuItemTitle={t('Share chart by email')}\n            emailSubject={t('Superset chart')}\n            emailBody={t('Check out this chart: ')}\n            addSuccessToast={addSuccessToast}\n            addDangerToast={addDangerToast}\n            copyMenuItemRef={copyLinkMenuRef}\n            shareByEmailMenuItemRef={shareByEmailMenuRef}\n            selectedKeys={selectedKeys.filter(\n              key => key === MenuKeys.CopyLink || key === MenuKeys.ShareByEmail,\n            )}\n          />\n        </Menu.SubMenu>\n      )}\n\n      {props.supersetCanCSV && (\n        <Menu.SubMenu\n          title={t('Download')}\n          key={MenuKeys.Download}\n          onTitleMouseEnter={() => setOpenKeys(undefined)}\n        >\n          <Menu.Item\n            key={MenuKeys.ExportCsv}\n            icon={<Icons.FileOutlined css={dropdownIconsStyles} />}\n          >\n            {t('Export to .CSV')}\n          </Menu.Item>\n          {isPivotTable && (\n            <Menu.Item\n              key={MenuKeys.ExportPivotCsv}\n              icon={<Icons.FileOutlined css={dropdownIconsStyles} />}\n            >\n              {t('Export to Pivoted .CSV')}\n            </Menu.Item>\n          )}\n          <Menu.Item\n            key={MenuKeys.ExportXlsx}\n            icon={<Icons.FileOutlined css={dropdownIconsStyles} />}\n          >\n            {t('Export to Excel')}\n          </Menu.Item>\n\n          {isFeatureEnabled(FeatureFlag.AllowFullCsvExport) &&\n            props.supersetCanCSV &&\n            isTable && (\n              <>\n                <Menu.Item\n                  key={MenuKeys.ExportFullCsv}\n                  icon={<Icons.FileOutlined css={dropdownIconsStyles} />}\n                >\n                  {t('Export to full .CSV')}\n                </Menu.Item>\n                <Menu.Item\n                  key={MenuKeys.ExportFullXlsx}\n                  icon={<Icons.FileOutlined css={dropdownIconsStyles} />}\n                >\n                  {t('Export to full Excel')}\n                </Menu.Item>\n              </>\n            )}\n\n          <Menu.Item\n            key={MenuKeys.DownloadAsImage}\n            icon={<Icons.FileImageOutlined css={dropdownIconsStyles} />}\n          >\n            {t('Download as image')}\n          </Menu.Item>\n        </Menu.SubMenu>\n      )}\n    </Menu>\n  );\n\n  return (\n    <>\n      {isFullSize && (\n        <Icons.FullscreenExitOutlined\n          style={{ fontSize: 22 }}\n          onClick={() => {\n            props.handleToggleFullSize();\n          }}\n        />\n      )}\n      <NoAnimationDropdown\n        overlay={menu}\n        overlayStyle={dropdownOverlayStyle}\n        trigger={['click']}\n        placement=\"bottomRight\"\n        visible={dropdownIsOpen}\n        onVisibleChange={status => toggleDropdown({ close: !status })}\n        onKeyDown={e =>\n          handleDropdownNavigation(\n            e,\n            dropdownIsOpen,\n            menu,\n            toggleDropdown,\n            setSelectedKeys,\n            setOpenKeys,\n          )\n        }\n      >\n        <span\n          css={() => css`\n            display: flex;\n            align-items: center;\n          `}\n          id={`slice_${slice.slice_id}-controls`}\n          role=\"button\"\n          aria-label=\"More Options\"\n          aria-haspopup=\"true\"\n          tabIndex={0}\n        >\n          <VerticalDotsTrigger />\n        </span>\n      </NoAnimationDropdown>\n      {canEditCrossFilters && scopingModal}\n    </>\n  );\n};\n\nexport default withRouter(SliceHeaderControls);\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}